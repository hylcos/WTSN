///////////////////////////////////////////////////////////////////////////////
//
// IAR C/C++ Compiler V9.20.1.2476 for 8051               16/Feb/2016  09:50:02
// Copyright 2004-2015 IAR Systems AB.
// Standalone license - IAR Embedded Workbench for 8051
//
//    Core               =  plain
//    Code model         =  near
//    Data model         =  large
//    Calling convention =  xdata reentrant
//    Constant location  =  data
//    Dptr setup         =  1,16
//                          
//    Source file        =  
//        C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\Source\sb_exec_v2.c
//    Command line       =  
//        "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\Source\sb_exec_v2.c" -D
//        HAL_SB_BOOT_CODE -D HAL_UART_SPI=2 -D
//        LOCK_THE_BOOT_IMAGE_PAGES_IN_HEX_FILE -D SBL_WAIT_TIME=60 -D
//        NO_WD_RESET_FOR_BOOTLOADER -lC "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\CC2530ZNP\List\"
//        -lA "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\CC2530ZNP\List\"
//        -o "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\CC2530ZNP\Obj\" -e
//        --debug --core=plain --dptr=16,1 --data_model=large --code_model=near
//        --calling_convention=xdata_reentrant --place_constants=data
//        --nr_virtual_regs 16 -I "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\..\Source\" -I
//        "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\source\" -I
//        "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\..\..\..\..\..\COMPONENTS\HAL\INCLUDE\"
//        -I "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\..\..\..\..\..\COMPONENTS\HAL\TARGET\_COMMON\CC2530\"
//        -I "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\..\..\..\..\..\COMPONENTS\HAL\TARGET\CC2530ZNP\"
//        -I "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\..\..\..\..\..\COMPONENTS\OSAL\INCLUDE\"
//        -I "C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\" -Ohz
//        --require_prototypes
//    List file          =  
//        C:\Texas Instruments\Z-Stack Mesh
//        1.0.0\Projects\zstack\Utilities\BootLoad\CC2530ZNP\CC2530ZNP\List\sb_exec_v2.s51
//
///////////////////////////////////////////////////////////////////////////////

        NAME sb_exec_v2

        RTMODEL "__SystemLibrary", "CLib"
        RTMODEL "__calling_convention", "xdata_reentrant"
        RTMODEL "__code_model", "near"
        RTMODEL "__core", "plain"
        RTMODEL "__data_model", "large"
        RTMODEL "__dptr_size", "16"
        RTMODEL "__extended_stack", "disabled"
        RTMODEL "__location_for_constants", "data"
        RTMODEL "__number_of_dptrs", "1"
        RTMODEL "__rt_version", "1"

        RSEG DOVERLAY:DATA:NOROOT(0)
        RSEG IOVERLAY:IDATA:NOROOT(0)
        RSEG ISTACK:IDATA:NOROOT(0)
        RSEG PSTACK:XDATA:NOROOT(0)
        RSEG XSTACK:XDATA:NOROOT(0)

        EXTERN ?V0
        EXTERN ?V1
        EXTERN ?V2
        EXTERN ?V3
        EXTERN ?V4
        EXTERN ?V5
        EXTERN ?V6
        EXTERN ?V7
        EXTERN ?V8
        EXTERN ?V9
        EXTERN ?V10
        EXTERN ?V11
        EXTERN ?V12
        EXTERN ?V13
        EXTERN ?V14
        EXTERN ?V15
        EXTERN ?ADD_XSTACK_DISP0_16
        EXTERN ?ALLOC_XSTACK8
        EXTERN ?DEALLOC_XSTACK8
        EXTERN ?FUNC_ENTER_XDATA
        EXTERN ?FUNC_LEAVE_XDATA
        EXTERN ?L_ADD
        EXTERN ?L_ADD_X
        EXTERN ?L_MOV_TO_X
        EXTERN ?L_MOV_X
        EXTERN ?PUSH_XSTACK_I_TWO
        EXTERN ?S_SHL
        EXTERN ?UL_GE_X
        EXTERN ?UL_SHR
        EXTERN ?US_SHR
        EXTERN ?XSP
        EXTERN ?XSTACK_DISP0_8
        EXTERN ?XSTACK_DISP101_8
        EXTERN ?XSTACK_DISP102_8
        EXTERN __INIT_XDATA_I
        EXTERN __INIT_XDATA_Z

        PUBWEAK U0BAUD
        PUBWEAK U0GCR
        PUBWEAK _A_IEN0
        PUBWEAK __Constant_200
        PUBWEAK __Constant_3c800
        PUBWEAK __Constant_4
        PUBWEAK __Constant_ffffdf70
        PUBWEAK __Constant_ffffffff
        PUBLIC _sblCmdAddr
        PUBLIC _sblRev
        PUBLIC _sblSig
        FUNCTION calcCRC,0a1203H
        ARGFRAME XSTACK, 14, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        LOCFRAME ISTACK, 2, STACK
        LOCFRAME XSTACK, 537, STACK
        PUBLIC mainAppCommand
        FUNCTION runPoly,0203H
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCTION sbCmnd,0a1203H
        ARGFRAME XSTACK, 10, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        LOCFRAME XSTACK, 29, STACK
        PUBLIC sbExec
        FUNCTION sbExec,0a1203H
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        LOCFRAME ISTACK, 1, STACK
        LOCFRAME XSTACK, 10, STACK
        PUBLIC sbImgValid
        FUNCTION sbImgValid,0a1203H
        ARGFRAME XSTACK, 0, STACK
        LOCFRAME XSTACK, 16, STACK
        PUBLIC sbReportState
        FUNCTION sbReportState,021203H
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        LOCFRAME XSTACK, 8, STACK
        FUNCTION sbResp,0a1203H
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        LOCFRAME ISTACK, 1, STACK
        LOCFRAME XSTACK, 8, STACK
        
          CFI Names cfiNames0
          CFI StackFrame CFA_SP SP IDATA
          CFI StackFrame CFA_PSP16 PSP16 XDATA
          CFI StackFrame CFA_XSP16 XSP16 XDATA
          CFI StaticOverlayFrame CFA_IOVERLAY IOVERLAY
          CFI StaticOverlayFrame CFA_DOVERLAY DOVERLAY
          CFI Resource `PSW.CY`:1, `B.BR0`:1, `B.BR1`:1, `B.BR2`:1, `B.BR3`:1
          CFI Resource `B.BR4`:1, `B.BR5`:1, `B.BR6`:1, `B.BR7`:1, `VB.BR8`:1
          CFI Resource `VB.BR9`:1, `VB.BR10`:1, `VB.BR11`:1, `VB.BR12`:1
          CFI Resource `VB.BR13`:1, `VB.BR14`:1, `VB.BR15`:1, VB:8, B:8, A:8
          CFI Resource PSW:8, DPL0:8, DPH0:8, R0:8, R1:8, R2:8, R3:8, R4:8, R5:8
          CFI Resource R6:8, R7:8, V0:8, V1:8, V2:8, V3:8, V4:8, V5:8, V6:8, V7:8
          CFI Resource V8:8, V9:8, V10:8, V11:8, V12:8, V13:8, V14:8, V15:8, SP:8
          CFI Resource PSPH:8, PSPL:8, PSP16:16, XSPH:8, XSPL:8, XSP16:16
          CFI VirtualResource ?RET:16, ?RET_HIGH:8, ?RET_LOW:8
          CFI ResourceParts PSP16 PSPH, PSPL
          CFI ResourceParts XSP16 XSPH, XSPL
          CFI ResourceParts ?RET ?RET_HIGH, ?RET_LOW
          CFI EndNames cfiNames0
        
          CFI Common cfiCommon0 Using cfiNames0
          CFI CodeAlign 1
          CFI DataAlign -1
          CFI ReturnAddress ?RET CODE
          CFI CFA_DOVERLAY Used
          CFI CFA_IOVERLAY Used
          CFI CFA_SP SP+-2
          CFI CFA_PSP16 PSP16+0
          CFI CFA_XSP16 XSP16+0
          CFI `PSW.CY` SameValue
          CFI `B.BR0` SameValue
          CFI `B.BR1` SameValue
          CFI `B.BR2` SameValue
          CFI `B.BR3` SameValue
          CFI `B.BR4` SameValue
          CFI `B.BR5` SameValue
          CFI `B.BR6` SameValue
          CFI `B.BR7` SameValue
          CFI `VB.BR8` SameValue
          CFI `VB.BR9` SameValue
          CFI `VB.BR10` SameValue
          CFI `VB.BR11` SameValue
          CFI `VB.BR12` SameValue
          CFI `VB.BR13` SameValue
          CFI `VB.BR14` SameValue
          CFI `VB.BR15` SameValue
          CFI VB SameValue
          CFI B Undefined
          CFI A Undefined
          CFI PSW SameValue
          CFI DPL0 SameValue
          CFI DPH0 SameValue
          CFI R0 Undefined
          CFI R1 Undefined
          CFI R2 Undefined
          CFI R3 Undefined
          CFI R4 Undefined
          CFI R5 Undefined
          CFI R6 SameValue
          CFI R7 SameValue
          CFI V0 SameValue
          CFI V1 SameValue
          CFI V2 SameValue
          CFI V3 SameValue
          CFI V4 SameValue
          CFI V5 SameValue
          CFI V6 SameValue
          CFI V7 SameValue
          CFI V8 SameValue
          CFI V9 SameValue
          CFI V10 SameValue
          CFI V11 SameValue
          CFI V12 SameValue
          CFI V13 SameValue
          CFI V14 SameValue
          CFI V15 SameValue
          CFI PSPH Undefined
          CFI PSPL Undefined
          CFI XSPH Undefined
          CFI XSPL Undefined
          CFI ?RET Concat
          CFI ?RET_HIGH Frame(CFA_SP, 2)
          CFI ?RET_LOW Frame(CFA_SP, 1)
          CFI EndCommon cfiCommon0
        
        
          CFI Common cfiCommon1 Using cfiNames0
          CFI CodeAlign 1
          CFI DataAlign -1
          CFI ReturnAddress ?RET CODE
          CFI CFA_DOVERLAY Used
          CFI CFA_IOVERLAY Used
          CFI CFA_SP SP+-2
          CFI CFA_PSP16 PSP16+0
          CFI CFA_XSP16 XSP16+0
          CFI `PSW.CY` SameValue
          CFI `B.BR0` SameValue
          CFI `B.BR1` SameValue
          CFI `B.BR2` SameValue
          CFI `B.BR3` SameValue
          CFI `B.BR4` SameValue
          CFI `B.BR5` SameValue
          CFI `B.BR6` SameValue
          CFI `B.BR7` SameValue
          CFI `VB.BR8` SameValue
          CFI `VB.BR9` SameValue
          CFI `VB.BR10` SameValue
          CFI `VB.BR11` SameValue
          CFI `VB.BR12` SameValue
          CFI `VB.BR13` SameValue
          CFI `VB.BR14` SameValue
          CFI `VB.BR15` SameValue
          CFI VB SameValue
          CFI B SameValue
          CFI A SameValue
          CFI PSW SameValue
          CFI DPL0 SameValue
          CFI DPH0 SameValue
          CFI R0 SameValue
          CFI R1 SameValue
          CFI R2 SameValue
          CFI R3 SameValue
          CFI R4 SameValue
          CFI R5 SameValue
          CFI R6 SameValue
          CFI R7 SameValue
          CFI V0 SameValue
          CFI V1 SameValue
          CFI V2 SameValue
          CFI V3 SameValue
          CFI V4 SameValue
          CFI V5 SameValue
          CFI V6 SameValue
          CFI V7 SameValue
          CFI V8 SameValue
          CFI V9 SameValue
          CFI V10 SameValue
          CFI V11 SameValue
          CFI V12 SameValue
          CFI V13 SameValue
          CFI V14 SameValue
          CFI V15 SameValue
          CFI PSPH Undefined
          CFI PSPL Undefined
          CFI XSPH Undefined
          CFI XSPL Undefined
          CFI ?RET Concat
          CFI ?RET_HIGH Frame(CFA_SP, 2)
          CFI ?RET_LOW Frame(CFA_SP, 1)
          CFI EndCommon cfiCommon1
        
        EXTERN HalFlashErase
        FUNCTION HalFlashErase,0202H
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        EXTERN HalFlashRead
        FUNCTION HalFlashRead,0202H
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 537, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        EXTERN HalFlashWrite
        FUNCTION HalFlashWrite,0202H
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 29, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        EXTERN sbRx
        FUNCTION sbRx,0202H
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 10, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        EXTERN sbStateReportingEnabled
        EXTERN sbTx
        FUNCTION sbTx,0202H
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 8, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        EXTERN sbUartPoll
        FUNCTION sbUartPoll,0202H
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        EXTERN sblIsUartTxPending
        FUNCTION sblIsUartTxPending,0202H
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        EXTERN vddWait
        FUNCTION vddWait,0202H
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        EXTERN znpCfg1

// C:\Texas Instruments\Z-Stack Mesh 1.0.0\Projects\zstack\Utilities\BootLoad\Source\sb_exec_v2.c
//    1 /**************************************************************************************************
//    2   Filename:       sb_exec.c
//    3   Revised:        $Date: 2014-08-04 15:38:03 -0700 (Mon, 04 Aug 2014) $
//    4   Revision:       $Revision: 39653 $
//    5 
//    6   Description:    Serial Bootloader Executive.
//    7 
//    8   Copyright 2014 Texas Instruments Incorporated. All rights reserved.
//    9 
//   10   IMPORTANT: Your use of this Software is limited to those specific rights
//   11   granted under the terms of a software license agreement between the user
//   12   who downloaded the software, his/her employer (which must be your employer)
//   13   and Texas Instruments Incorporated (the "License"). You may not use this
//   14   Software unless you agree to abide by the terms of the License. The License
//   15   limits your use, and you acknowledge, that the Software may not be modified,
//   16   copied or distributed unless embedded on a Texas Instruments microcontroller
//   17   or used solely and exclusively in conjunction with a Texas Instruments radio
//   18   frequency transceiver, which is integrated into your product. Other than for
//   19   the foregoing purpose, you may not use, reproduce, copy, prepare derivative
//   20   works of, modify, distribute, perform, display or sell this Software and/or
//   21   its documentation for any purpose.
//   22 
//   23   YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
//   24   PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
//   25   INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
//   26   NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
//   27   TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
//   28   NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
//   29   LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
//   30   INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
//   31   OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
//   32   OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
//   33   (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
//   34 
//   35   Should you have any questions regarding your right to use this Software,
//   36   contact Texas Instruments Incorporated at www.TI.com. 
//   37 **************************************************************************************************/
//   38 
//   39 /* ------------------------------------------------------------------------------------------------
//   40  *                                          Includes 
//   41  * ------------------------------------------------------------------------------------------------
//   42  */
//   43 
//   44 #include "hal_board_cfg.h"

        ASEGN SFR_AN:DATA:NOROOT,0a8H
// union <unnamed> volatile __sfr _A_IEN0
_A_IEN0:
        DATA8
        DS 1

        ASEGN SFR_AN:DATA:NOROOT,0c2H
// unsigned char volatile __sfr U0BAUD
U0BAUD:
        DATA8
        DS 1

        ASEGN SFR_AN:DATA:NOROOT,0c5H
// unsigned char volatile __sfr U0GCR
U0GCR:
        DATA8
        DS 1
//   45 #include "hal_flash.h"
//   46 #include "hal_types.h"
//   47 #include "sb_exec_v2.h"
//   48 #include "sb_main.h"
//   49 #ifdef INCLUDE_REVISION_INFORMATION
//   50 #include "revision_info.h"
//   51 #else
//   52 #define CODE_REVISION_NUMBER 0
//   53 #endif
//   54 #include "sb_shared.h"
//   55 
//   56 /* ------------------------------------------------------------------------------------------------
//   57  *                                          Constants
//   58  * ------------------------------------------------------------------------------------------------
//   59  */
//   60 
//   61 #if !defined MT_SYS_OSAL_NV_READ_CERTIFICATE_DATA
//   62 #define MT_SYS_OSAL_NV_READ_CERTIFICATE_DATA  FALSE
//   63 #endif
//   64 
//   65 #define TIME_IT_TAKES_TO_CALC_CRC 30 //seconds, approx
//   66 
//   67 /* ------------------------------------------------------------------------------------------------
//   68  *                                       Local Variables
//   69  * ------------------------------------------------------------------------------------------------
//   70  */
//   71 

        RSEG XDATA_Z:XDATA:NOROOT(0)
        DATA8
//   72 static uint8 sbBuf[SB_BUF_SIZE], sbCmd1, sbCmd2, sbFcs, sbIdx, sbLen, sbSte;
sbBuf:
        DS 128
        REQUIRE __INIT_XDATA_Z

        RSEG XDATA_Z:XDATA:NOROOT(0)
        DATA8
sbCmd1:
        DS 1
        REQUIRE __INIT_XDATA_Z

        RSEG XDATA_Z:XDATA:NOROOT(0)
        DATA8
sbCmd2:
        DS 1
        REQUIRE __INIT_XDATA_Z

        RSEG XDATA_Z:XDATA:NOROOT(0)
        DATA8
sbFcs:
        DS 1
        REQUIRE __INIT_XDATA_Z

        RSEG XDATA_Z:XDATA:NOROOT(0)
        DATA8
sbIdx:
        DS 1
        REQUIRE __INIT_XDATA_Z

        RSEG XDATA_Z:XDATA:NOROOT(0)
        DATA8
sbLen:
        DS 1
        REQUIRE __INIT_XDATA_Z

        RSEG XDATA_Z:XDATA:NOROOT(0)
        DATA8
sbSte:
        DS 1
        REQUIRE __INIT_XDATA_Z
//   73   
//   74 /* ------------------------------------------------------------------------------------------------
//   75  *                                       Local Functions
//   76  * ------------------------------------------------------------------------------------------------
//   77  */
//   78 
//   79 static uint8 sbCmnd(void);
//   80 static void sbResp(uint8 rsp, uint8 len);
//   81 static uint16 calcCRC(uint8 * abort);
//   82 static uint16 runPoly(uint16 crc, uint8 val);
//   83 
//   84 /* ------------------------------------------------------------------------------------------------
//   85  *                                       Externals
//   86  * ------------------------------------------------------------------------------------------------
//   87  */
//   88 extern uint8 znpCfg1;
//   89 
//   90 /* ------------------------------------------------------------------------------------------------
//   91  *                                       System-Globals
//   92  * ------------------------------------------------------------------------------------------------
//   93  */
//   94  

        RSEG XDATA_N:XDATA:REORDER:NOROOT(0)
        DATA32
//   95 __no_init volatile uint32 mainAppCommand;
mainAppCommand:
        DS 4
//   96 
//   97 #pragma location="SBL_CMD"

        RSEG SBL_CMD:CODE:REORDER:NOROOT(0)
        DATA16
//   98 const CODE uint16 _sblCmdAddr = (uint16)&mainAppCommand;
_sblCmdAddr:
        DW mainAppCommand
//   99 #pragma required=_sblCmdAddr
//  100 	
//  101 #pragma location="SBL_SIG"

        RSEG SBL_SIG:CODE:REORDER:NOROOT(0)
        DATA32
//  102 const CODE uint32 _sblSig = SBL_SIGNATURE;
_sblSig:
        DD 2251834121
        REQUIRE _sblCmdAddr
//  103 #pragma required=_sblSig
//  104 	
//  105 #pragma location="SBL_REV"

        RSEG SBL_REV:CODE:REORDER:NOROOT(0)
        DATA32
//  106 const CODE uint32 _sblRev = CODE_REVISION_NUMBER;
_sblRev:
        DD 0
        REQUIRE _sblSig
//  107 #pragma required=_sblRev
//  108 
//  109 /* ------------------------------------------------------------------------------------------------
//  110  *                                       Functional Macros
//  111  * ------------------------------------------------------------------------------------------------
//  112  */
//  113  
//  114 #define DOES_BUF_CONTAIN_PRECALC_CRC(wordAddr) ((wordAddr <= (HAL_SB_CRC_ADDR / HAL_FLASH_WORD_SIZE)) && ((wordAddr + (SB_RW_BUF_LEN / HAL_FLASH_WORD_SIZE)) >= ((HAL_SB_CRC_ADDR + (HAL_SB_CRC_LEN / 2)) / HAL_FLASH_WORD_SIZE)))
//  115 
//  116 /* ------------------------------------------------------------------------------------------------
//  117  *                                       Functions
//  118  * ------------------------------------------------------------------------------------------------
//  119  */
//  120  
//  121 /**************************************************************************************************
//  122  * @fn          sbReportState
//  123  *
//  124  * @brief       Report the given state to the applicationBoot Loader main executive processing.
//  125  *
//  126  * input parameters
//  127  *
//  128  *   state -the state to report
//  129  *
//  130  * output parameters
//  131  *
//  132  * None.
//  133  *
//  134  * @return      (none)
//  135  **************************************************************************************************
//  136  */

        RSEG NEAR_CODE:CODE:NOROOT(0)
//  137 void sbReportState(uint8 state)
sbReportState:
          CFI Block cfiBlock0 Using cfiCommon0
          CFI Function sbReportState
        CODE
//  138 {
        FUNCALL sbReportState, sbResp
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 8, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 8, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        MOV     A,#-0x8
        LCALL   ?FUNC_ENTER_XDATA
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI CFA_SP SP+0
          CFI CFA_XSP16 add(XSP16, 8)
        ; Saved register size: 8
        ; Auto size: 0
//  139   if (sbStateReportingEnabled)
        MOV     DPTR,#sbStateReportingEnabled
        MOVX    A,@DPTR
        JZ      ??sbReportState_0
//  140   {
//  141     sbBuf[SB_SOF_STATE] = SB_SOF;
        MOV     DPTR,#sbBuf
        MOV     A,#-0x2
        MOVX    @DPTR,A
//  142     sbBuf[SB_CMD1_STATE] = SB_RPC_SYS_BOOT;
        MOV     DPTR,#sbBuf + 2
        MOV     A,#0x4d
        MOVX    @DPTR,A
//  143     sbBuf[SB_CMD2_STATE] = SB_STATE_IND;
        INC     DPTR
        MOV     A,#0x5
        MOVX    @DPTR,A
//  144     sbResp(state,1);
        ; Setup parameters for call to function sbResp
        MOV     R2,#0x1
        LCALL   sbResp
//  145   }
//  146 }
??sbReportState_0:
          CFI EndBlock cfiBlock0
        REQUIRE ?Subroutine0
        REQUIRE _sblRev
        ; // Fall through to label ?Subroutine0

        RSEG NEAR_CODE:CODE:NOROOT(0)
?Subroutine0:
          CFI Block cfiBlock1 Using cfiCommon0
          CFI NoFunction
          CFI CFA_SP SP+0
          CFI CFA_XSP16 add(XSP16, 8)
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
        MOV     R7,#0x1
        LJMP    ?FUNC_LEAVE_XDATA
          CFI CFA_SP SP+-2
          CFI CFA_XSP16 XSP16+0
          CFI VB SameValue
          CFI DPL0 SameValue
          CFI DPH0 SameValue
          CFI R6 SameValue
          CFI R7 SameValue
          CFI V0 SameValue
          CFI ?RET_HIGH Frame(CFA_SP, 2)
          CFI ?RET_LOW Frame(CFA_SP, 1)
          CFI EndBlock cfiBlock1
//  147 
//  148 /**************************************************************************************************
//  149  * @fn          sbExec
//  150  *
//  151  * @brief       Boot Loader main executive processing.
//  152  *
//  153  * input parameters
//  154  *
//  155  * None.
//  156  *
//  157  * output parameters
//  158  *
//  159  * None.
//  160  *
//  161  * @return      SB_CMND_IDLE if no command was currently executed, otherwise, returns a constant
//  162  *              that indicates the command that was just executed. See "sbCmnd Result Codes"
//  163  **************************************************************************************************
//  164  */

        RSEG NEAR_CODE:CODE:NOROOT(0)
//  165 uint8 sbExec(void)
sbExec:
          CFI Block cfiBlock2 Using cfiCommon0
          CFI Function sbExec
        CODE
//  166 {
        FUNCALL sbExec, sbRx
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 10, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 10, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbExec, sbCmnd
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 10, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 10, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        REQUIRE ?V0
        REQUIRE ?V1
        MOV     A,#-0x9
        LCALL   ?FUNC_ENTER_XDATA
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI V1 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI CFA_SP SP+0
          CFI CFA_XSP16 add(XSP16, 9)
        ; Saved register size: 9
        ; Auto size: 1
        MOV     A,#-0x1
        LCALL   ?ALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 10)
//  167   uint8 ch, rtrn = SB_CMND_IDLE;
        MOV     R6,#0x0
        SJMP    ??sbExec_0
//  168 
//  169   while (SB_RX(&ch))
//  170   {
//  171     if (ch == SB_FORCE_RUN)
//  172     {
//  173       rtrn = SB_CMND_FORCE_RUN;
//  174     }
//  175     
//  176     sbBuf[sbSte + sbIdx] = ch;
//  177     switch (sbSte)
//  178     {
//  179     case SB_SOF_STATE:
//  180       if (SB_SOF == ch)
??sbExec_1:
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        XRL     A,#0xfe
        JNZ     ??sbExec_2
//  181       {
//  182         sbSte = SB_LEN_STATE;
        MOV     DPTR,#sbSte
        MOV     A,#0x1
??sbExec_3:
        MOVX    @DPTR,A
//  183       }
//  184       break;
//  185     
//  186     case SB_LEN_STATE:
//  187       sbFcs = 0;
//  188       sbSte = ((sbLen = ch) >= SB_BUF_SIZE) ? SB_SOF_STATE : SB_CMD1_STATE;
//  189       break;
//  190 
//  191     case SB_CMD1_STATE:
//  192       sbCmd1 = ch;
//  193       sbSte = SB_CMD2_STATE;
//  194       break;
//  195     
//  196     case SB_CMD2_STATE:
//  197       sbCmd2 = ch;
//  198       sbSte = (sbLen) ? SB_DATA_STATE : SB_FCS_STATE;
//  199       break;
//  200 
//  201     case SB_DATA_STATE:
//  202       if (++sbIdx == sbLen)
//  203       {
//  204         sbSte = SB_FCS_STATE;
//  205       }
//  206       break;
//  207     
//  208     case SB_FCS_STATE:
//  209       sbSte = sbIdx = 0;
//  210 	  
//  211       if ((sbFcs == ch) && (sbCmd1 == SB_RPC_SYS_BOOT))
//  212       {
//  213         return sbCmnd();
//  214       }
//  215       else
//  216       {
//  217         // TODO - RemoTI did not have here or on bad length - adding could cause > 1 SB_INVALID_FCS
//  218         //        for a single data packet which could put out of sync with PC for awhile or
//  219         //        infinte, depending on PC-side?
//  220         // sbResp(SB_INVALID_FCS, 1);
//  221       }
//  222       break;
//  223     
//  224     default:
//  225       break;
//  226     }
//  227     sbFcs ^= ch;
??sbExec_2:
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        MOV     R0,A
        MOV     DPTR,#sbFcs
        MOVX    A,@DPTR
        XRL     A,R0
        MOVX    @DPTR,A
??sbExec_0:
        ; Setup parameters for call to function sbRx
        MOV     R4,#0x1
        MOV     R5,#0x0
        MOV     R2,?XSP + 0
        MOV     R3,?XSP + 1
        LCALL   sbRx
        MOV     ?V1,R3
        MOV     A,R2
        ORL     A,?V1
        JNZ     $+5
        LJMP    ??sbExec_4
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        XRL     A,#0xef
        JNZ     ??sbExec_5
        MOV     R6,#0x7
??sbExec_5:
        MOVX    A,@DPTR
        PUSH    A
          CFI CFA_SP SP+-1
        MOV     DPTR,#sbSte
        MOVX    A,@DPTR
        MOV     R2,A
        MOV     DPTR,#sbIdx
        MOVX    A,@DPTR
        MOV     R0,A
        MOV     A,R2
        ADD     A,R0
        MOV     R0,A
        CLR     A
        ADDC    A,#0x0
        MOV     R1,A
        MOV     A,#sbBuf & 0xff
        ADD     A,R0
        MOV     DPL,A
        MOV     A,#(sbBuf >> 8) & 0xff
        ADDC    A,R1
        MOV     DPH,A
        POP     A
          CFI CFA_SP SP+0
        MOVX    @DPTR,A
        MOV     DPTR,#sbSte
        MOVX    A,@DPTR
        JZ      ??sbExec_1
        DEC     A
        JZ      ??sbExec_6
        DEC     A
        JZ      ??sbExec_7
        DEC     A
        JZ      ??sbExec_8
        DEC     A
        JZ      ??sbExec_9
        DEC     A
        JZ      ??sbExec_10
        SJMP    ??sbExec_2
??sbExec_6:
        MOV     DPTR,#sbFcs
        CLR     A
        MOVX    @DPTR,A
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        MOV     DPTR,#sbLen
        MOVX    @DPTR,A
        CLR     C
        SUBB    A,#-0x80
        MOV     DPTR,#sbSte
        JC      ??sbExec_11
        CLR     A
        LJMP    ??sbExec_3
??sbExec_11:
        MOV     A,#0x2
        LJMP    ??sbExec_3
??sbExec_7:
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        MOV     DPTR,#sbCmd1
        MOVX    @DPTR,A
        MOV     DPTR,#sbSte
        MOV     A,#0x3
        LJMP    ??sbExec_3
??sbExec_8:
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        MOV     DPTR,#sbCmd2
        MOVX    @DPTR,A
        MOV     DPTR,#sbLen
        MOVX    A,@DPTR
        JZ      ??sbExec_12
        MOV     DPTR,#sbSte
        MOV     A,#0x4
        LJMP    ??sbExec_3
??sbExec_9:
        MOV     DPTR,#sbIdx
        MOVX    A,@DPTR
        INC     A
        MOVX    @DPTR,A
        MOV     R0,A
        MOV     DPTR,#sbLen
        MOVX    A,@DPTR
        XRL     A,R0
        JZ      $+5
        LJMP    ??sbExec_2
??sbExec_12:
        MOV     DPTR,#sbSte
        MOV     A,#0x5
        LJMP    ??sbExec_3
??sbExec_10:
        MOV     DPTR,#sbIdx
        CLR     A
        MOVX    @DPTR,A
        MOV     DPTR,#sbSte
        MOVX    @DPTR,A
        MOV     DPTR,#sbFcs
        MOVX    A,@DPTR
        MOV     R0,A
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        XRL     A,R0
        JZ      $+5
        LJMP    ??sbExec_2
        MOV     DPTR,#sbCmd1
        MOVX    A,@DPTR
        XRL     A,#0x4d
        JZ      $+5
        LJMP    ??sbExec_2
        ; Setup parameters for call to function sbCmnd
        LCALL   sbCmnd
        SJMP    ??sbExec_13
//  228   }
//  229 
//  230   return rtrn;
??sbExec_4:
        MOV     A,R6
        MOV     R1,A
??sbExec_13:
        MOV     A,#0x1
          CFI EndBlock cfiBlock2
        REQUIRE ?Subroutine1
        ; // Fall through to label ?Subroutine1
//  231 }

        RSEG NEAR_CODE:CODE:NOROOT(0)
?Subroutine1:
          CFI Block cfiBlock3 Using cfiCommon0
          CFI NoFunction
          CFI CFA_SP SP+0
          CFI CFA_XSP16 add(XSP16, 10)
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI V1 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI Invalid
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 9)
          CFI Valid
        MOV     R7,#0x2
        LJMP    ?FUNC_LEAVE_XDATA
          CFI CFA_SP SP+-2
          CFI CFA_XSP16 XSP16+0
          CFI VB SameValue
          CFI DPL0 SameValue
          CFI DPH0 SameValue
          CFI R6 SameValue
          CFI R7 SameValue
          CFI V0 SameValue
          CFI V1 SameValue
          CFI ?RET_HIGH Frame(CFA_SP, 2)
          CFI ?RET_LOW Frame(CFA_SP, 1)
          CFI EndBlock cfiBlock3
//  232 
//  233 /**************************************************************************************************
//  234  * @fn          sbImgValid
//  235  *
//  236  * @brief       Check validity of the run-code image.
//  237  *
//  238  * input parameters
//  239  *
//  240  * None.
//  241  *
//  242  * output parameters
//  243  *
//  244  * None.
//  245  *
//  246  * @return      TRUE or FALSE for image valid.
//  247  **************************************************************************************************
//  248  */

        RSEG NEAR_CODE:CODE:NOROOT(0)
//  249 uint8 sbImgValid(uint8 * time_spent_validating)
sbImgValid:
          CFI Block cfiBlock4 Using cfiCommon0
          CFI Function sbImgValid
        CODE
//  250 {
        FUNCALL sbImgValid, HalFlashRead
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 16, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 16, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbImgValid, calcCRC
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 14, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 14, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbImgValid, sbReportState
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 14, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 14, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbImgValid, HalFlashWrite
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 16, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 16, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbImgValid, HalFlashRead
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 16, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 16, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbImgValid, sbReportState
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 14, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 14, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbImgValid, sbReportState
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 14, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 14, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbImgValid, sbReportState
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 14, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 14, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        REQUIRE ?V0
        REQUIRE ?V1
        MOV     A,#-0x9
        LCALL   ?FUNC_ENTER_XDATA
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI V1 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI CFA_SP SP+0
          CFI CFA_XSP16 add(XSP16, 9)
        ; Saved register size: 9
        ; Auto size: 5
        MOV     A,#-0x5
        LCALL   ?ALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 14)
        MOV     A,R2
        MOV     R6,A
        MOV     A,R3
        MOV     R7,A
//  251   uint16 crc[2];
//  252   uint8 abort;
//  253   
//  254   HalFlashRead(HAL_SB_CRC_ADDR / HAL_FLASH_PAGE_SIZE,
//  255     HAL_SB_CRC_ADDR % HAL_FLASH_PAGE_SIZE,
//  256     (uint8 *)crc, sizeof(crc));
        ; Setup parameters for call to function HalFlashRead
        MOV     ?V0,#0x4
        MOV     ?V1,#0x0
        MOV     R0,#?V0
        LCALL   ?PUSH_XSTACK_I_TWO
          CFI CFA_XSP16 add(XSP16, 16)
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP102_8
        MOV     R2,#-0x70
        MOV     R3,#0x0
        MOV     R1,#0x4
        LCALL   HalFlashRead
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 14)
//  257   
//  258   if ((crc[0] != crc[1]) || (crc[0] == 0xFFFF))
        LCALL   ?Subroutine2
??CrossCallReturnLabel_0:
        LCALL   ?XSTACK_DISP0_8
        MOVX    A,@DPTR
        XRL     A,R0
        JNZ     ??sbImgValid_0
        INC     DPTR
        MOVX    A,@DPTR
        XRL     A,R1
??sbImgValid_0:
        JNZ     ??sbImgValid_1
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        CPL     A
        JNZ     ??sbImgValid_2
        INC     DPTR
        MOVX    A,@DPTR
        CPL     A
??sbImgValid_2:
        JZ      $+5
        LJMP    ??sbImgValid_3
//  259   {
//  260     crc[1] = calcCRC(&abort);
??sbImgValid_1:
        ; Setup parameters for call to function calcCRC
        MOV     A,#0x4
        LCALL   ?XSTACK_DISP101_8
        LCALL   calcCRC
        MOV     ?V0,R2
        MOV     ?V1,R3
        MOV     R0,?V0
        MOV     R1,?V1
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP0_8
        MOV     A,R0
        MOVX    @DPTR,A
        INC     DPTR
        MOV     A,R1
        MOVX    @DPTR,A
//  261     
//  262     if (abort)
        MOV     A,#0x4
        LCALL   ?XSTACK_DISP0_8
        MOVX    A,@DPTR
        JZ      ??sbImgValid_4
//  263     {
//  264       sbReportState(SB_STATE_VERIFICATION_ABORTED);
        ; Setup parameters for call to function sbReportState
        MOV     R1,#0x1
        LCALL   sbReportState
//  265       return FALSE;
        LJMP    ??sbImgValid_5
//  266     }
//  267     
//  268     if (crc[0] == crc[1])
??sbImgValid_4:
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        XRL     A,R0
        JNZ     ??sbImgValid_6
        INC     DPTR
        MOVX    A,@DPTR
        XRL     A,R1
??sbImgValid_6:
        JNZ     ??sbImgValid_7
//  269     {
//  270       if (crc[0] == 0xFFFF)
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        CPL     A
        JNZ     ??sbImgValid_8
        INC     DPTR
        MOVX    A,@DPTR
        CPL     A
??sbImgValid_8:
        JNZ     ??sbImgValid_9
//  271       {
//  272         crc[0] = crc[1] = 0x2010;
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP0_8
        MOV     A,#0x10
        MOVX    @DPTR,A
        INC     DPTR
        MOV     A,#0x20
        MOVX    @DPTR,A
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOV     A,#0x10
        MOVX    @DPTR,A
        INC     DPTR
        MOV     A,#0x20
        MOVX    @DPTR,A
//  273       }
//  274       
//  275       HalFlashWrite((HAL_SB_CRC_ADDR / HAL_FLASH_WORD_SIZE), (uint8 *)crc, 1);
??sbImgValid_9:
        ; Setup parameters for call to function HalFlashWrite
        MOV     ?V0,#0x1
        MOV     ?V1,#0x0
        MOV     R0,#?V0
        LCALL   ?PUSH_XSTACK_I_TWO
          CFI CFA_XSP16 add(XSP16, 16)
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP102_8
        MOV     R2,#0x24
        MOV     R3,#0x8
        LCALL   HalFlashWrite
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 14)
//  276       HalFlashRead(  HAL_SB_CRC_ADDR / HAL_FLASH_PAGE_SIZE,
//  277         HAL_SB_CRC_ADDR % HAL_FLASH_PAGE_SIZE,
//  278         (uint8 *)crc, sizeof(crc));
        ; Setup parameters for call to function HalFlashRead
        MOV     ?V0,#0x4
        MOV     R0,#?V0
        LCALL   ?PUSH_XSTACK_I_TWO
          CFI CFA_XSP16 add(XSP16, 16)
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP102_8
        MOV     R2,#-0x70
        MOV     R3,#0x0
        MOV     R1,#0x4
        LCALL   HalFlashRead
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 14)
//  279       if (crc[0] == crc[1])
        LCALL   ?Subroutine2
??CrossCallReturnLabel_1:
        LCALL   ?XSTACK_DISP0_8
        MOVX    A,@DPTR
        XRL     A,R0
        JNZ     ??sbImgValid_10
        INC     DPTR
        MOVX    A,@DPTR
        XRL     A,R1
??sbImgValid_10:
        JNZ     ??sbImgValid_11
//  280       {
//  281         sbReportState(SB_STATE_VERIFICATION_IMAGE_VALID);
        ; Setup parameters for call to function sbReportState
        MOV     R1,#0x2
        SJMP    ??sbImgValid_12
//  282       }
//  283       else
//  284       {
//  285         sbReportState(SB_STATE_VERIFICATION_FAILED);
??sbImgValid_11:
        ; Setup parameters for call to function sbReportState
        MOV     R1,#0x4
        SJMP    ??sbImgValid_12
//  286       }
//  287     }
//  288     else
//  289     {
//  290       sbReportState(SB_STATE_VERIFICATION_IMAGE_INVALID);
??sbImgValid_7:
        ; Setup parameters for call to function sbReportState
        MOV     R1,#0x3
??sbImgValid_12:
        LCALL   sbReportState
//  291     }
//  292 	
//  293     *time_spent_validating = TIME_IT_TAKES_TO_CALC_CRC;
        MOV     DPL,R6
        MOV     DPH,R7
        MOV     A,#0x1e
        SJMP    ??sbImgValid_13
//  294   }
//  295   else
//  296   {
//  297     *time_spent_validating = 0;
??sbImgValid_3:
        MOV     DPL,R6
        MOV     DPH,R7
        CLR     A
??sbImgValid_13:
        MOVX    @DPTR,A
//  298   }
//  299   
//  300   return (crc[0] == crc[1]);
        LCALL   ?Subroutine2
??CrossCallReturnLabel_2:
        LCALL   ?XSTACK_DISP0_8
        MOVX    A,@DPTR
        XRL     A,R0
        JNZ     ??sbImgValid_14
        INC     DPTR
        MOVX    A,@DPTR
        XRL     A,R1
??sbImgValid_14:
        JNZ     ??sbImgValid_5
        MOV     R1,#0x1
        SJMP    ??sbImgValid_15
??sbImgValid_5:
        MOV     R1,#0x0
??sbImgValid_15:
        MOV     A,#0x5
        LJMP    ?Subroutine1
//  301 }
          CFI EndBlock cfiBlock4
//  302 
//  303 /**************************************************************************************************
//  304 * @fn          sbCmnd
//  305 *
//  306 * @brief       Act on the SB command and received buffer.
//  307 *
//  308 * input parameters
//  309 *
//  310 * None.
//  311 *
//  312 * output parameters
//  313 *
//  314 * None.
//  315 *
//  316 * @return      SB_CMND_IDLE is no command was currently executed, otherwise, returns a constant
//  317 *              that indicates the command that was just executed. See "sbCmnd Result Codes"
//  318 **************************************************************************************************
//  319 */

        RSEG NEAR_CODE:CODE:NOROOT(0)
//  320 static uint8 sbCmnd(void)
sbCmnd:
          CFI Block cfiBlock5 Using cfiCommon0
          CFI Function sbCmnd
        CODE
//  321 {
        FUNCALL sbCmnd, vddWait
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 27, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, sbResp
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 27, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, vddWait
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 27, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, HalFlashErase
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 27, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, HalFlashWrite
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 29, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 29, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, HalFlashRead
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 29, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 29, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, HalFlashRead
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 29, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 29, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, HalFlashWrite
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 29, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 29, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, HalFlashRead
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 29, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 29, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, sbResp
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 27, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, sbUartPoll
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 27, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, sblIsUartTxPending
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 27, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL sbCmnd, sbResp
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 27, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 27, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        REQUIRE ?V0
        REQUIRE ?V1
        REQUIRE ?V2
        REQUIRE ?V3
        REQUIRE ?V4
        REQUIRE ?V5
        REQUIRE ?V6
        REQUIRE ?V7
        REQUIRE ?V8
        REQUIRE ?V9
        REQUIRE ?V10
        REQUIRE ?V11
        MOV     A,#-0x13
        LCALL   ?FUNC_ENTER_XDATA
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI CFA_SP SP+0
          CFI CFA_XSP16 add(XSP16, 19)
        ; Saved register size: 19
        ; Auto size: 8
        MOV     A,#-0x8
        LCALL   ?ALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 27)
//  322   uint16 tmp = BUILD_UINT16(sbBuf[SB_DATA_STATE], sbBuf[SB_DATA_STATE+1]) + SB_IMG_OSET;
        MOV     DPTR,#sbBuf + 5
        MOVX    A,@DPTR
        MOV     R2,A
        MOV     DPTR,#sbBuf + 4
        MOVX    A,@DPTR
        MOV     R1,A
        MOV     R6,A
        MOV     A,R2
        MOV     R4,A
        CLR     A
        XCH     A,R4
        MOV     R5,A
        MOV     A,R6
        ADD     A,R4
        MOV     A,R5
        ADDC    A,#0x8
        MOV     R7,A
//  323   uint16 crc[2];
//  324   uint8 len = 1;
        MOV     ?V8,#0x1
//  325   uint8 rsp = SB_SUCCESS;
        MOV     ?V3,#0x0
//  326   uint8 rtrn = SB_CMND_UNSUPPORTED;
        MOV     ?V2,#0x6
//  327   uint8 *pBuf;
//  328   static uint8 crcPatched = FALSE;
//  329   
//  330   
//  331   switch (sbCmd2)
        MOV     ?V0,R6
        MOV     ?V1,R7
        MOV     A,#0x2
        MOV     R0,#?V0
        LCALL   ?S_SHL
        CLR     C
        SUBB    A,?V0
        MOV     R4,A
        CLR     A
        SUBB    A,?V1
        MOV     R5,A
        MOV     A,#sbBuf & 0xff
        ADD     A,R4
        MOV     ?V6,A
        MOV     A,#(sbBuf >> 8) & 0xff
        ADDC    A,R5
        MOV     ?V7,A
        MOV     A,?V6
        ADD     A,#-0x69
        MOV     ?V10,A
        MOV     A,?V7
        ADDC    A,#0x20
        MOV     ?V11,A
        MOV     ?V0,R6
        MOV     ?V1,R7
        MOV     A,#0x9
        MOV     R0,#?V0
        LCALL   ?US_SHR
        MOV     A,?V0
        MOV     ?V9,A
        MOV     A,R6
        ADD     A,#0x10
        MOV     ?V0,A
        CLR     A
        ADDC    A,R7
        MOV     ?V1,A
        MOV     A,R6
        MOV     ?V4,A
        MOV     A,R7
        ANL     A,#0x1
        MOV     ?V5,A
        MOV     DPTR,#sbCmd2
        MOVX    A,@DPTR
        DEC     A
        JZ      ??sbCmnd_0
        DEC     A
        JNZ     $+5
        LJMP    ??sbCmnd_1
        DEC     A
        JNZ     $+5
        LJMP    ??sbCmnd_2
        DEC     A
        JZ      ??sbCmnd_3
        ADD     A,#-0x2
        JNZ     $+5
        LJMP    ??sbCmnd_4
        DEC     A
        JNZ     $+5
        LJMP    ??sbCmnd_5
        LJMP    ??sbCmnd_6
//  332   {
//  333     case SB_HANDSHAKE_CMD:
//  334       rtrn = SB_CMND_HANDSHAKE_CMD;
??sbCmnd_3:
        MOV     ?V2,#0x3
//  335       vddWait(VDD_MIN_NV);
        ; Setup parameters for call to function vddWait
        MOV     R1,#0x4e
        LCALL   vddWait
//  336       
//  337       pBuf = &sbBuf[SB_DATA_STATE+1];
//  338       UINT32_TO_BUF_LITTLE_ENDIAN(pBuf, SB_BOOTLOADER_REVISION);
        MOV     DPTR,#sbBuf + 5
        LCALL   ??Subroutine5_0
//  339       *pBuf++ = SB_DEVICE_TYPE_2530;
??CrossCallReturnLabel_9:
        MOV     A,#0x2
        MOVX    @DPTR,A
//  340       UINT32_TO_BUF_LITTLE_ENDIAN(pBuf, SB_RW_BUF_LEN);
        INC     DPTR
        MOV     A,#0x40
        LCALL   ?Subroutine3
//  341       UINT32_TO_BUF_LITTLE_ENDIAN(pBuf, SB_DEVICE_PAGE_SIZE);
??CrossCallReturnLabel_7:
        MOV     A,#0x8
        LCALL   ?Subroutine3
//  342       UINT32_TO_BUF_LITTLE_ENDIAN(pBuf, _sblRev);
??CrossCallReturnLabel_8:
        MOVX    @DPTR,A
        INC     DPTR
        MOVX    @DPTR,A
//  343       len += (pBuf - &sbBuf[SB_DATA_STATE+1]);
        MOV     A,#(sbBuf + 22) & 0xff
        CLR     C
        SUBB    A,#(sbBuf + 5) & 0xff
        INC     A
        MOV     ?V8,A
//  344       break;
//  345     
//  346     case SB_WRITE_CMD:
//  347       rtrn = SB_CMND_WRITE_CMD;
//  348       vddWait(VDD_MIN_NV); // in case handshake was not performed. Anyhow, if already waited for this voltage, vddWait() will return immidiately
//  349       
//  350       if ((tmp % SB_WPG_SIZE) == 0)
//  351       {
//  352         HalFlashErase(tmp / SB_WPG_SIZE);
//  353       }
//  354 
//  355       /* If the pre-calculated checksum is 0x0000, change it to 0xA5A5 when writing to flash.
//  356          When calculating checksum at runtime, 0x0000 is also converted to 0xA5A5. This way
//  357          0x0000 is never written as valid checksum in flash, which allows the main application
//  358          to invalidate the image by writing 0x0000 to the crc shadow field in flash. */
//  359 
//  360       if (DOES_BUF_CONTAIN_PRECALC_CRC(tmp)) //the next flash write includes the pre-calculated CRC
//  361       {
//  362         pBuf = &sbBuf[SB_DATA_STATE + 2 + (HAL_SB_CRC_ADDR - ((uint32)tmp * HAL_FLASH_WORD_SIZE))];
//  363 		  
//  364         if ((pBuf[0] == 0)
//  365           && (pBuf[1] == 0))
//  366         {
//  367           crcPatched = TRUE;
//  368           pBuf[0] = 0xA5;
//  369           pBuf[1] = 0xA5;
//  370         }
//  371         else
//  372         {
//  373           crcPatched = FALSE;
//  374         }
//  375       }
//  376 
//  377       HalFlashWrite(tmp, sbBuf+SB_DATA_STATE+2, SB_RW_BUF_LEN / HAL_FLASH_WORD_SIZE);
//  378       break;
//  379     
//  380     case SB_READ_CMD:
//  381       rtrn = SB_CMND_READ_CMD;
//  382 #if !MT_SYS_OSAL_NV_READ_CERTIFICATE_DATA
//  383       if ((tmp / (HAL_FLASH_PAGE_SIZE / 4)) >= HAL_NV_PAGE_BEG)
//  384       {
//  385         rsp = SB_FAILURE;
//  386         break;
//  387       }
//  388 #endif
//  389       HalFlashRead(tmp / (HAL_FLASH_PAGE_SIZE / 4),
//  390         (tmp % (HAL_FLASH_PAGE_SIZE / 4)) << 2,
//  391         sbBuf + SB_DATA_STATE + 3, SB_RW_BUF_LEN);
//  392       sbBuf[SB_DATA_STATE+2] = sbBuf[SB_DATA_STATE+1];
//  393       sbBuf[SB_DATA_STATE+1] = sbBuf[SB_DATA_STATE];
//  394       len = SB_RW_BUF_LEN + 3;
//  395 
//  396       if (DOES_BUF_CONTAIN_PRECALC_CRC(tmp) //the current flash read block include the pre-calculated CRC
//  397         && crcPatched)
//  398       {
//  399         pBuf = &sbBuf[SB_DATA_STATE + 3 + (HAL_SB_CRC_ADDR - ((uint32)tmp * HAL_FLASH_WORD_SIZE))];
//  400 		
//  401         pBuf[0] = 0;
//  402         pBuf[1] = 0;
//  403       }
//  404       break;
//  405     
//  406     case SB_ENABLE_CMD:
//  407       HalFlashRead(HAL_SB_CRC_ADDR / HAL_FLASH_PAGE_SIZE,
//  408         HAL_SB_CRC_ADDR % HAL_FLASH_PAGE_SIZE,
//  409         (uint8 *)crc, sizeof(crc));
//  410       
//  411       // Bootload master must have verified extra checks to be issuing the SB_ENABLE_CMD.
//  412       if ((crc[1] != crc[0]) || (crc[0] == 0xFFFF))
//  413       {
//  414         if (crc[0] == 0xFFFF)
//  415         {
//  416           crc[0] = 0x2010;
//  417         }
//  418         crc[1] = crc[0];
//  419         HalFlashWrite((HAL_SB_CRC_ADDR / HAL_FLASH_WORD_SIZE), (uint8 *)crc, 1);
//  420         HalFlashRead(  HAL_SB_CRC_ADDR / HAL_FLASH_PAGE_SIZE,
//  421           HAL_SB_CRC_ADDR % HAL_FLASH_PAGE_SIZE,
//  422           (uint8 *)crc, sizeof(crc));
//  423       }
//  424       
//  425       if (crc[0] == crc[1])
//  426       {
//  427         rtrn = SB_CMND_ENABLED_CMD_OK;
//  428       }
//  429       else
//  430       {
//  431         rtrn = SB_CMND_ENABLED_CMD_ERROR;
//  432         rsp = SB_VALIDATE_FAILED;
//  433       }
//  434       break;
//  435 
//  436     case SB_SWITCH_BAUDRATE_CMD:
//  437       if ((znpCfg1 == ZNP_CFG1_UART) || (znpCfg1 == ZNP_CFG1_UART_USB))
//  438       {
//  439         uint8 _U0BAUD = sbBuf[SB_DATA_STATE + 0];
//  440         uint8 _U0GCR = sbBuf[SB_DATA_STATE + 1];
//  441         
//  442         sbResp(rsp, len); //first, send the response using the old baudrate
//  443         
//  444         if (znpCfg1 == ZNP_CFG1_UART)
//  445         {
//  446           while(sblIsUartTxPending())
//  447           {
//  448             sbUartPoll();
//  449           }
//  450           
//  451           SLEEP(0x2600); //without this wait, the FCS is deformed, since the baudrate will change while the FCS is still in the TX fifo.
//  452   
//  453           U0BAUD = _U0BAUD;
//  454           U0GCR = ((U0GCR&~0x1F) | _U0GCR);
//  455          
//  456           SLEEP(0x2600); //wait for the new baudrate to take effect
//  457         }
//  458         
//  459         sbResp(rsp, len); //now, resend the response using the new baudrate
//  460 
//  461         return SB_CMND_SWITCH_BAUDRAT;
//  462       }
//  463       break;
//  464 
//  465     case SB_ENABLE_REPORTING_CMD:
//  466       sbStateReportingEnabled = sbBuf[SB_DATA_STATE];
//  467       if (sbStateReportingEnabled)
//  468       {
//  469         rtrn = SB_CMND_ENABLE_STATE_REPORTING;
//  470       }
//  471       break;
//  472 
//  473     default:
//  474       return SB_CMND_UNSUPPORTED;
//  475       break;
//  476   }
//  477   
//  478   sbResp(rsp, len);
??sbCmnd_7:
        ; Setup parameters for call to function sbResp
        MOV     R2,?V8
        MOV     R1,?V3
        LCALL   sbResp
//  479   return rtrn;
        MOV     R1,?V2
??sbCmnd_8:
        MOV     A,#0x8
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 19)
        MOV     R7,#0xc
        LJMP    ?FUNC_LEAVE_XDATA
          CFI CFA_XSP16 add(XSP16, 27)
??sbCmnd_0:
        MOV     ?V2,#0x4
        ; Setup parameters for call to function vddWait
        MOV     R1,#0x4e
        LCALL   vddWait
        MOV     A,R6
        ORL     A,?V5
        JNZ     ??sbCmnd_9
        ; Setup parameters for call to function HalFlashErase
        MOV     R1,?V9
        LCALL   HalFlashErase
??sbCmnd_9:
        CLR     C
        MOV     A,R6
        SUBB    A,#0x25
        MOV     A,R7
        SUBB    A,#0x8
        JNC     ??sbCmnd_10
        CLR     C
        MOV     A,?V0
        SUBB    A,#0x24
        MOV     A,?V1
        SUBB    A,#0x8
        JC      ??sbCmnd_10
        MOV     A,?V6
        ADD     A,#-0x6a
        MOV     R0,A
        MOV     A,?V7
        ADDC    A,#0x20
        MOV     R1,A
        MOV     DPL,R0
        MOV     DPH,R1
        MOVX    A,@DPTR
        JNZ     ??sbCmnd_11
        MOV     DPL,?V10
        MOV     DPH,?V11
        MOVX    A,@DPTR
        JNZ     ??sbCmnd_11
        MOV     DPTR,#??crcPatched
        MOV     A,#0x1
        MOVX    @DPTR,A
        MOV     DPL,R0
        MOV     DPH,R1
        MOV     A,#-0x5b
        MOVX    @DPTR,A
        MOV     DPL,?V10
        MOV     DPH,?V11
        SJMP    ??sbCmnd_12
??sbCmnd_11:
        MOV     DPTR,#??crcPatched
        CLR     A
??sbCmnd_12:
        MOVX    @DPTR,A
??sbCmnd_10:
        ; Setup parameters for call to function HalFlashWrite
        MOV     ?V0,#0x10
        MOV     ?V1,#0x0
        MOV     R0,#?V0
        LCALL   ?PUSH_XSTACK_I_TWO
          CFI CFA_XSP16 add(XSP16, 29)
        MOV     R4,#(sbBuf + 6) & 0xff
        MOV     R5,#((sbBuf + 6) >> 8) & 0xff
        MOV     A,R6
        MOV     R2,A
        MOV     A,R7
        MOV     R3,A
        LCALL   HalFlashWrite
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 27)
        LJMP    ??sbCmnd_7
??sbCmnd_1:
        MOV     ?V2,#0x5
        MOV     A,?V9
        CLR     C
        SUBB    A,#0x79
        JC      ??sbCmnd_13
        MOV     ?V3,#0x1
        LJMP    ??sbCmnd_7
??sbCmnd_13:
        ; Setup parameters for call to function HalFlashRead
        MOV     ?V6,#0x40
        MOV     ?V7,#0x0
        MOV     R0,#?V6
        LCALL   ?PUSH_XSTACK_I_TWO
          CFI CFA_XSP16 add(XSP16, 29)
        MOV     R4,#(sbBuf + 7) & 0xff
        MOV     R5,#((sbBuf + 7) >> 8) & 0xff
        MOV     A,#0x2
        MOV     R0,#?V4
        LCALL   ?S_SHL
        MOV     R2,?V4
        MOV     R3,?V5
        MOV     R1,?V9
        LCALL   HalFlashRead
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 27)
        MOV     DPTR,#sbBuf + 5
        MOVX    A,@DPTR
        INC     DPTR
        MOVX    @DPTR,A
        MOV     DPTR,#sbBuf + 4
        MOVX    A,@DPTR
        INC     DPTR
        MOVX    @DPTR,A
        MOV     ?V8,#0x43
        CLR     C
        MOV     A,R6
        SUBB    A,#0x25
        MOV     A,R7
        SUBB    A,#0x8
        JC      $+5
        LJMP    ??sbCmnd_7
        CLR     C
        MOV     A,?V0
        SUBB    A,#0x24
        MOV     A,?V1
        SUBB    A,#0x8
        JNC     $+5
        LJMP    ??sbCmnd_7
        MOV     DPTR,#??crcPatched
        MOVX    A,@DPTR
        JNZ     $+5
        LJMP    ??sbCmnd_7
        MOV     R0,?V10
        MOV     R1,?V11
        MOV     DPL,R0
        MOV     DPH,R1
        CLR     A
        MOVX    @DPTR,A
        INC     DPTR
        MOVX    @DPTR,A
        LJMP    ??sbCmnd_7
??sbCmnd_2:
        ; Setup parameters for call to function HalFlashRead
        MOV     ?V0,#0x4
        MOV     ?V1,#0x0
        MOV     R0,#?V0
        LCALL   ?PUSH_XSTACK_I_TWO
          CFI CFA_XSP16 add(XSP16, 29)
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP102_8
        MOV     R2,#-0x70
        MOV     R3,#0x0
        MOV     R1,#0x4
        LCALL   HalFlashRead
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 27)
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP0_8
        MOVX    A,@DPTR
        MOV     R0,A
        INC     DPTR
        MOVX    A,@DPTR
        MOV     R1,A
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        XRL     A,R0
        JNZ     ??sbCmnd_14
        INC     DPTR
        MOVX    A,@DPTR
        XRL     A,R1
??sbCmnd_14:
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        JNZ     ??sbCmnd_15
        MOVX    A,@DPTR
        CPL     A
        JNZ     ??sbCmnd_16
        INC     DPTR
        MOVX    A,@DPTR
        CPL     A
??sbCmnd_16:
        JNZ     ??sbCmnd_17
        SJMP    ??sbCmnd_18
??sbCmnd_15:
        MOVX    A,@DPTR
        CPL     A
        JNZ     ??sbCmnd_19
        INC     DPTR
        MOVX    A,@DPTR
        CPL     A
??sbCmnd_19:
        JNZ     ??sbCmnd_20
??sbCmnd_18:
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOV     A,#0x10
        MOVX    @DPTR,A
        INC     DPTR
        MOV     A,#0x20
        MOVX    @DPTR,A
??sbCmnd_20:
        LCALL   ?Subroutine2
??CrossCallReturnLabel_3:
        LCALL   ?XSTACK_DISP0_8
        MOV     A,R0
        MOVX    @DPTR,A
        INC     DPTR
        MOV     A,R1
        MOVX    @DPTR,A
        ; Setup parameters for call to function HalFlashWrite
        MOV     ?V0,#0x1
        MOV     R0,#?V0
        LCALL   ?PUSH_XSTACK_I_TWO
          CFI CFA_XSP16 add(XSP16, 29)
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP102_8
        MOV     R2,#0x24
        MOV     R3,#0x8
        LCALL   HalFlashWrite
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 27)
        ; Setup parameters for call to function HalFlashRead
        MOV     ?V0,#0x4
        MOV     R0,#?V0
        LCALL   ?PUSH_XSTACK_I_TWO
          CFI CFA_XSP16 add(XSP16, 29)
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP102_8
        MOV     R2,#-0x70
        MOV     R3,#0x0
        MOV     R1,#0x4
        LCALL   HalFlashRead
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 27)
??sbCmnd_17:
        LCALL   ?Subroutine2
??CrossCallReturnLabel_4:
        LCALL   ?XSTACK_DISP0_8
        MOVX    A,@DPTR
        XRL     A,R0
        JNZ     ??sbCmnd_21
        INC     DPTR
        MOVX    A,@DPTR
        XRL     A,R1
??sbCmnd_21:
        JNZ     ??sbCmnd_22
        MOV     ?V2,#0x1
        LJMP    ??sbCmnd_7
??sbCmnd_22:
        MOV     ?V2,#0x2
        MOV     ?V3,#0x7
        LJMP    ??sbCmnd_7
??sbCmnd_4:
        MOV     DPTR,#znpCfg1
        MOVX    A,@DPTR
        JZ      ??sbCmnd_23
        XRL     A,#0x2
        JZ      $+5
        LJMP    ??sbCmnd_7
??sbCmnd_23:
        MOV     A,R2
        MOV     R7,A
        ; Setup parameters for call to function sbResp
        MOV     R2,#0x1
        MOV     R1,#0x0
        LCALL   sbResp
        MOVX    A,@DPTR
        JZ      $+5
        LJMP    ??sbCmnd_24
        SJMP    ??sbCmnd_25
??sbCmnd_26:
        ; Setup parameters for call to function sbUartPoll
        LCALL   sbUartPoll
??sbCmnd_25:
        ; Setup parameters for call to function sblIsUartTxPending
        LCALL   sblIsUartTxPending
        MOV     A,R1
        JNZ     ??sbCmnd_26
        MOV     A,#0x4
        LCALL   ?XSTACK_DISP0_8
        LCALL   ?Subroutine4
??CrossCallReturnLabel_5:
        MOV     A,#0x4
        LCALL   ?XSTACK_DISP0_8
        MOV     R0,#?V0
        LCALL   ?L_MOV_X
        MOV     ?V4,?V0
        MOV     ?V5,?V1
        MOV     ?V6,?V2
        MOV     ?V7,?V3
        MOV     DPTR,#__Constant_ffffffff
        MOV     R0,#?V4
        LCALL   ?L_ADD_X
        MOV     A,#0x4
        LCALL   ?XSTACK_DISP0_8
        MOV     R0,#?V4
        LCALL   ?L_MOV_TO_X
        MOV     A,?V0
        ORL     A,?V1
        ORL     A,?V2
        ORL     A,?V3
        JNZ     ??CrossCallReturnLabel_5
        MOV     0xc2,R6
        MOV     A,0xc5
        ANL     A,#0xe0
        ORL     A,R7
        MOV     0xc5,A
        MOV     A,#0x4
        LCALL   ?XSTACK_DISP0_8
        LCALL   ?Subroutine4
??CrossCallReturnLabel_6:
        MOV     A,#0x4
        LCALL   ?XSTACK_DISP0_8
        MOV     R0,#?V0
        LCALL   ?L_MOV_X
        MOV     ?V4,?V0
        MOV     ?V5,?V1
        MOV     ?V6,?V2
        MOV     ?V7,?V3
        MOV     DPTR,#__Constant_ffffffff
        MOV     R0,#?V4
        LCALL   ?L_ADD_X
        MOV     A,#0x4
        LCALL   ?XSTACK_DISP0_8
        MOV     R0,#?V4
        LCALL   ?L_MOV_TO_X
        MOV     A,?V0
        ORL     A,?V1
        ORL     A,?V2
        ORL     A,?V3
        JNZ     ??CrossCallReturnLabel_6
??sbCmnd_24:
        ; Setup parameters for call to function sbResp
        MOV     R2,#0x1
        MOV     R1,#0x0
        LCALL   sbResp
        MOV     R1,#0x8
        LJMP    ??sbCmnd_8
??sbCmnd_5:
        MOV     A,R1
        MOV     DPTR,#sbStateReportingEnabled
        MOVX    @DPTR,A
        JNZ     $+5
        LJMP    ??sbCmnd_7
        MOV     ?V2,#0x9
        LJMP    ??sbCmnd_7
??sbCmnd_6:
        MOV     R1,#0x6
        LJMP    ??sbCmnd_8
          CFI EndBlock cfiBlock5
        REQUIRE U0BAUD
        REQUIRE U0GCR
//  480 }

        RSEG NEAR_CODE:CODE:NOROOT(0)
?Subroutine4:
          CFI Block cfiCond6 Using cfiCommon0
          CFI Function sbCmnd
          CFI Conditional ??CrossCallReturnLabel_5
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI CFA_XSP16 add(XSP16, 27)
          CFI Block cfiCond7 Using cfiCommon0
          CFI (cfiCond7) Function sbCmnd
          CFI (cfiCond7) Conditional ??CrossCallReturnLabel_6
          CFI (cfiCond7) R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI (cfiCond7) VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI (cfiCond7) V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI (cfiCond7) V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI (cfiCond7) V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI (cfiCond7) V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI (cfiCond7) V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI (cfiCond7) V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI (cfiCond7) V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI (cfiCond7) V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI (cfiCond7) V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI (cfiCond7) V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI (cfiCond7) V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI (cfiCond7) V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI (cfiCond7) R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI (cfiCond7) ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI (cfiCond7) ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI (cfiCond7) DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI (cfiCond7) DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI (cfiCond7) CFA_XSP16 add(XSP16, 27)
          CFI Block cfiPicker8 Using cfiCommon1
          CFI (cfiPicker8) NoFunction
          CFI (cfiPicker8) Picker
        CLR     A
        MOVX    @DPTR,A
        INC     DPTR
        MOV     A,#0x26
        MOVX    @DPTR,A
        INC     DPTR
        CLR     A
        MOVX    @DPTR,A
        INC     DPTR
        MOVX    @DPTR,A
        RET
          CFI (cfiCond6) CFA_SP SP+0
          CFI (cfiCond7) CFA_SP SP+0
          CFI (cfiPicker8) CFA_SP SP+0
          CFI EndBlock cfiCond6
          CFI EndBlock cfiCond7
          CFI EndBlock cfiPicker8

        RSEG NEAR_CODE:CODE:NOROOT(0)
?Subroutine3:
          CFI Block cfiCond9 Using cfiCommon0
          CFI Function sbCmnd
          CFI Conditional ??CrossCallReturnLabel_7
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI CFA_XSP16 add(XSP16, 27)
          CFI Block cfiCond10 Using cfiCommon0
          CFI (cfiCond10) Function sbCmnd
          CFI (cfiCond10) Conditional ??CrossCallReturnLabel_8
          CFI (cfiCond10) R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI (cfiCond10) VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI (cfiCond10) V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI (cfiCond10) V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI (cfiCond10) V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI (cfiCond10) V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI (cfiCond10) V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI (cfiCond10) V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI (cfiCond10) V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI (cfiCond10) V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI (cfiCond10) V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI (cfiCond10) V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI (cfiCond10) V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI (cfiCond10) V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI (cfiCond10) R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI (cfiCond10) ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI (cfiCond10) ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI (cfiCond10) DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI (cfiCond10) DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI (cfiCond10) CFA_XSP16 add(XSP16, 27)
          CFI Block cfiPicker11 Using cfiCommon1
          CFI (cfiPicker11) NoFunction
          CFI (cfiPicker11) Picker
        MOVX    @DPTR,A
        INC     DPTR
          CFI EndBlock cfiCond9
          CFI EndBlock cfiCond10
          CFI EndBlock cfiPicker11
        REQUIRE ??Subroutine5_0
        ; // Fall through to label ??Subroutine5_0

        RSEG NEAR_CODE:CODE:NOROOT(0)
??Subroutine5_0:
          CFI Block cfiCond12 Using cfiCommon0
          CFI Function sbCmnd
          CFI Conditional ??CrossCallReturnLabel_9
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI CFA_XSP16 add(XSP16, 27)
          CFI Block cfiCond13 Using cfiCommon0
          CFI (cfiCond13) Function sbCmnd
          CFI (cfiCond13) Conditional ??CrossCallReturnLabel_7
          CFI (cfiCond13) R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI (cfiCond13) VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI (cfiCond13) V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI (cfiCond13) V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI (cfiCond13) V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI (cfiCond13) V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI (cfiCond13) V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI (cfiCond13) V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI (cfiCond13) V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI (cfiCond13) V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI (cfiCond13) V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI (cfiCond13) V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI (cfiCond13) V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI (cfiCond13) V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI (cfiCond13) R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI (cfiCond13) ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI (cfiCond13) ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI (cfiCond13) DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI (cfiCond13) DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI (cfiCond13) CFA_XSP16 add(XSP16, 27)
          CFI Block cfiCond14 Using cfiCommon0
          CFI (cfiCond14) Function sbCmnd
          CFI (cfiCond14) Conditional ??CrossCallReturnLabel_8
          CFI (cfiCond14) R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI (cfiCond14) VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI (cfiCond14) V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI (cfiCond14) V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI (cfiCond14) V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI (cfiCond14) V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI (cfiCond14) V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI (cfiCond14) V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI (cfiCond14) V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI (cfiCond14) V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI (cfiCond14) V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI (cfiCond14) V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI (cfiCond14) V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI (cfiCond14) V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI (cfiCond14) R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI (cfiCond14) ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI (cfiCond14) ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI (cfiCond14) DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI (cfiCond14) DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI (cfiCond14) CFA_XSP16 add(XSP16, 27)
          CFI Block cfiPicker15 Using cfiCommon1
          CFI (cfiPicker15) NoFunction
          CFI (cfiPicker15) Picker
        CLR     A
        MOVX    @DPTR,A
        INC     DPTR
        MOVX    @DPTR,A
        INC     DPTR
        MOVX    @DPTR,A
        INC     DPTR
        MOVX    @DPTR,A
        INC     DPTR
        RET
          CFI (cfiCond12) CFA_SP SP+0
          CFI (cfiCond13) CFA_SP SP+0
          CFI (cfiCond14) CFA_SP SP+0
          CFI (cfiPicker15) CFA_SP SP+0
          CFI EndBlock cfiCond12
          CFI EndBlock cfiCond13
          CFI EndBlock cfiCond14
          CFI EndBlock cfiPicker15

        RSEG NEAR_CODE:CODE:NOROOT(0)
?Subroutine2:
          CFI Block cfiCond16 Using cfiCommon0
          CFI Function sbImgValid
          CFI Conditional ??CrossCallReturnLabel_0
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI V1 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI CFA_XSP16 add(XSP16, 14)
          CFI Block cfiCond17 Using cfiCommon0
          CFI (cfiCond17) Function sbImgValid
          CFI (cfiCond17) Conditional ??CrossCallReturnLabel_1
          CFI (cfiCond17) R6 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI (cfiCond17) VB load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI (cfiCond17) V0 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI (cfiCond17) V1 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI (cfiCond17) R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI (cfiCond17) ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI (cfiCond17) ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI (cfiCond17) DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI (cfiCond17) DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI (cfiCond17) CFA_XSP16 add(XSP16, 14)
          CFI Block cfiCond18 Using cfiCommon0
          CFI (cfiCond18) Function sbImgValid
          CFI (cfiCond18) Conditional ??CrossCallReturnLabel_2
          CFI (cfiCond18) R6 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI (cfiCond18) VB load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI (cfiCond18) V0 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI (cfiCond18) V1 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI (cfiCond18) R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI (cfiCond18) ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI (cfiCond18) ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI (cfiCond18) DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI (cfiCond18) DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI (cfiCond18) CFA_XSP16 add(XSP16, 14)
          CFI Block cfiCond19 Using cfiCommon0
          CFI (cfiCond19) Function sbCmnd
          CFI (cfiCond19) Conditional ??CrossCallReturnLabel_3
          CFI (cfiCond19) R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI (cfiCond19) VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI (cfiCond19) V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI (cfiCond19) V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI (cfiCond19) V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI (cfiCond19) V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI (cfiCond19) V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI (cfiCond19) V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI (cfiCond19) V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI (cfiCond19) V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI (cfiCond19) V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI (cfiCond19) V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI (cfiCond19) V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI (cfiCond19) V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI (cfiCond19) R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI (cfiCond19) ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI (cfiCond19) ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI (cfiCond19) DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI (cfiCond19) DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI (cfiCond19) CFA_XSP16 add(XSP16, 27)
          CFI Block cfiCond20 Using cfiCommon0
          CFI (cfiCond20) Function sbCmnd
          CFI (cfiCond20) Conditional ??CrossCallReturnLabel_4
          CFI (cfiCond20) R6 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI (cfiCond20) VB load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI (cfiCond20) V0 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI (cfiCond20) V1 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI (cfiCond20) V2 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI (cfiCond20) V3 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI (cfiCond20) V4 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI (cfiCond20) V5 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI (cfiCond20) V6 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI (cfiCond20) V7 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI (cfiCond20) V8 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI (cfiCond20) V9 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI (cfiCond20) V10 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI (cfiCond20) V11 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI (cfiCond20) R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI (cfiCond20) ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI (cfiCond20) ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI (cfiCond20) DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI (cfiCond20) DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI (cfiCond20) CFA_XSP16 add(XSP16, 27)
          CFI Block cfiPicker21 Using cfiCommon1
          CFI (cfiPicker21) NoFunction
          CFI (cfiPicker21) Picker
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOVX    A,@DPTR
        MOV     R0,A
        INC     DPTR
        MOVX    A,@DPTR
        MOV     R1,A
        MOV     A,#0x2
        RET
          CFI (cfiCond16) CFA_SP SP+0
          CFI (cfiCond17) CFA_SP SP+0
          CFI (cfiCond18) CFA_SP SP+0
          CFI (cfiCond19) CFA_SP SP+0
          CFI (cfiCond20) CFA_SP SP+0
          CFI (cfiPicker21) CFA_SP SP+0
          CFI EndBlock cfiCond16
          CFI EndBlock cfiCond17
          CFI EndBlock cfiCond18
          CFI EndBlock cfiCond19
          CFI EndBlock cfiCond20
          CFI EndBlock cfiPicker21

        RSEG XDATA_Z:XDATA:NOROOT(0)
        DATA8
??crcPatched:
        DS 1
        REQUIRE __INIT_XDATA_Z
//  481 
//  482 /**************************************************************************************************
//  483  * @fn          sbResp
//  484  *
//  485  * @brief       Make the SB response.
//  486  *
//  487  * input parameters
//  488  *
//  489  * @param       rsp - The byte code response to send.
//  490  * @param       len - The data length of the response.
//  491  *
//  492  * output parameters
//  493  *
//  494  * None.
//  495  *
//  496  * @return      None.
//  497  **************************************************************************************************
//  498  */

        RSEG NEAR_CODE:CODE:NOROOT(0)
//  499 static void sbResp(uint8 rsp, uint8 len)
sbResp:
          CFI Block cfiBlock22 Using cfiCommon0
          CFI Function sbResp
        CODE
//  500 {
        FUNCALL sbResp, sbTx
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 8, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 8, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        REQUIRE ?V0
        MOV     A,#-0x8
        LCALL   ?FUNC_ENTER_XDATA
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI CFA_SP SP+0
          CFI CFA_XSP16 add(XSP16, 8)
        ; Saved register size: 8
        ; Auto size: 0
        MOV     A,R2
        MOV     R6,A
//  501   int8 idx;
//  502 
//  503   sbBuf[SB_CMD2_STATE] |= 0x80;
        MOV     DPTR,#sbBuf + 3
        MOVX    A,@DPTR
        SETB    0xE0 /* A   */.7
        MOVX    @DPTR,A
//  504   sbBuf[SB_DATA_STATE] = rsp;
        MOV     A,R1
        INC     DPTR
        MOVX    @DPTR,A
//  505   sbBuf[SB_LEN_STATE] = len;
        MOV     A,R6
        MOV     DPTR,#sbBuf + 1
        MOVX    @DPTR,A
//  506   rsp = len;
        MOV     ?V0,R6
//  507   len += SB_FCS_STATE - 1;
        MOV     A,#0x4
        ADD     A,R2
        MOV     R6,A
//  508 
//  509   for (idx = SB_CMD1_STATE; idx < len; idx++)
        MOV     R4,#0x2
        SJMP    ??sbResp_0
//  510   {
//  511     rsp ^= sbBuf[idx];
??sbResp_1:
        MOVX    A,@DPTR
        XRL     ?V0,A
//  512   }
        INC     R4
??sbResp_0:
        MOV     A,R4
        MOV     R2,A
        RLC     A
        SUBB    A,0xE0 /* A   */
        MOV     R3,A
        MOV     A,#sbBuf & 0xff
        ADD     A,R2
        MOV     DPL,A
        MOV     A,#(sbBuf >> 8) & 0xff
        ADDC    A,R3
        MOV     DPH,A
        MOV     A,R6
        MOV     R0,A
        CLR     C
        MOV     A,R2
        SUBB    A,R0
        MOV     A,R3
        SUBB    A,#0x0
        MOV     C,0xD0 /* PSW */.2
        XRL     A,PSW
        RLC     A
        JC      ??sbResp_1
//  513   sbBuf[idx++] = rsp;
        MOV     A,?V0
        MOVX    @DPTR,A
//  514   
//  515   SB_TX(sbBuf, idx);
        ; Setup parameters for call to function sbTx
        MOV     A,#0x1
        ADD     A,R2
        INC     R4
        RLC     A
        SUBB    A,0xE0 /* A   */
        MOV     R5,A
        MOV     R2,#sbBuf & 0xff
        MOV     R3,#(sbBuf >> 8) & 0xff
        LCALL   sbTx
//  516 }
        LJMP    ?Subroutine0
          CFI EndBlock cfiBlock22
//  517 
//  518 /**************************************************************************************************
//  519  * @fn          calcCRC
//  520  *
//  521  * @brief       Run the CRC16 Polynomial calculation over the RC image.
//  522  *
//  523  * input parameters
//  524  *
//  525  * None.
//  526  *
//  527  * output parameters
//  528  *
//  529  * None.
//  530  *
//  531  * @return      The CRC16 calculated.
//  532  **************************************************************************************************
//  533  */

        RSEG NEAR_CODE:CODE:NOROOT(0)
//  534 static uint16 calcCRC(uint8 * abort)
calcCRC:
          CFI Block cfiBlock23 Using cfiCommon0
          CFI Function calcCRC
        CODE
//  535 {
        FUNCALL calcCRC, sbReportState
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 535, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL calcCRC, sbUartPoll
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 535, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL calcCRC, sbExec
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 535, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL calcCRC, sbReportState
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 535, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL calcCRC, HalFlashRead
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 537, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 537, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL calcCRC, runPoly
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 535, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL calcCRC, runPoly
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 535, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        FUNCALL calcCRC, runPoly
        LOCFRAME ISTACK, 0, STACK
        LOCFRAME PSTACK, 0, STACK
        LOCFRAME XSTACK, 535, STACK
        LOCFRAME IOVERLAY, 0, STATIC
        LOCFRAME DOVERLAY, 0, STATIC
        ARGFRAME ISTACK, 0, STACK
        ARGFRAME PSTACK, 0, STACK
        ARGFRAME XSTACK, 535, STACK
        ARGFRAME IOVERLAY, 0, STATIC
        ARGFRAME DOVERLAY, 0, STATIC
        REQUIRE ?V0
        REQUIRE ?V1
        REQUIRE ?V2
        REQUIRE ?V3
        REQUIRE ?V4
        REQUIRE ?V5
        REQUIRE ?V6
        REQUIRE ?V7
        REQUIRE ?V8
        REQUIRE ?V9
        REQUIRE ?V10
        REQUIRE ?V11
        REQUIRE ?V12
        REQUIRE ?V13
        REQUIRE ?V14
        REQUIRE ?V15
        MOV     A,#-0x17
        LCALL   ?FUNC_ENTER_XDATA
          CFI DPH0 load(1, XDATA, add(CFA_XSP16, literal(-1)))
          CFI DPL0 load(1, XDATA, add(CFA_XSP16, literal(-2)))
          CFI ?RET_HIGH load(1, XDATA, add(CFA_XSP16, literal(-3)))
          CFI ?RET_LOW load(1, XDATA, add(CFA_XSP16, literal(-4)))
          CFI R7 load(1, XDATA, add(CFA_XSP16, literal(-5)))
          CFI V15 load(1, XDATA, add(CFA_XSP16, literal(-6)))
          CFI V14 load(1, XDATA, add(CFA_XSP16, literal(-7)))
          CFI V13 load(1, XDATA, add(CFA_XSP16, literal(-8)))
          CFI V12 load(1, XDATA, add(CFA_XSP16, literal(-9)))
          CFI V11 load(1, XDATA, add(CFA_XSP16, literal(-10)))
          CFI V10 load(1, XDATA, add(CFA_XSP16, literal(-11)))
          CFI V9 load(1, XDATA, add(CFA_XSP16, literal(-12)))
          CFI V8 load(1, XDATA, add(CFA_XSP16, literal(-13)))
          CFI V7 load(1, XDATA, add(CFA_XSP16, literal(-14)))
          CFI V6 load(1, XDATA, add(CFA_XSP16, literal(-15)))
          CFI V5 load(1, XDATA, add(CFA_XSP16, literal(-16)))
          CFI V4 load(1, XDATA, add(CFA_XSP16, literal(-17)))
          CFI V3 load(1, XDATA, add(CFA_XSP16, literal(-18)))
          CFI V2 load(1, XDATA, add(CFA_XSP16, literal(-19)))
          CFI V1 load(1, XDATA, add(CFA_XSP16, literal(-20)))
          CFI V0 load(1, XDATA, add(CFA_XSP16, literal(-21)))
          CFI VB load(1, XDATA, add(CFA_XSP16, literal(-22)))
          CFI R6 load(1, XDATA, add(CFA_XSP16, literal(-23)))
          CFI CFA_SP SP+0
          CFI CFA_XSP16 add(XSP16, 23)
        ; Saved register size: 23
        ; Auto size: 512
        MOV     DPL,#0x0
        MOV     DPH,#-0x2
        LCALL   ?ADD_XSTACK_DISP0_16
          CFI CFA_XSP16 add(XSP16, 535)
        MOV     ?V14,R2
        MOV     ?V15,R3
//  536   uint32 addr;
//  537   uint16 crc = 0;
        MOV     ?V12,#0x0
        MOV     ?V13,#0x0
//  538   uint8 buf[512];
//  539   int i;
//  540   uint16 chunk_size = sizeof(buf);
//  541   *abort = FALSE;
        MOV     DPL,R2
        MOV     DPH,R3
        CLR     A
        MOVX    @DPTR,A
//  542   uint8 sbExec_rc;
//  543   
//  544   if (znpCfg1 == ZNP_CFG1_UART)
        MOV     DPTR,#znpCfg1
        MOVX    A,@DPTR
        JNZ     ??calcCRC_0
//  545   {
//  546     URX0IE = 1;
        SETB    0xa8.2
//  547     HAL_ENABLE_INTERRUPTS();
        SETB    0xa8.7
        SJMP    ??calcCRC_1
//  548   }
//  549 
//  550   if ((znpCfg1 == ZNP_CFG1_UART) || (znpCfg1 == ZNP_CFG1_UART_USB))
??calcCRC_0:
        XRL     A,#0x2
        JNZ     ??calcCRC_2
//  551   {
//  552     sbReportState(SB_STATE_VERIFYING);
??calcCRC_1:
        ; Setup parameters for call to function sbReportState
        MOV     R1,#0x0
        LCALL   sbReportState
//  553   }
//  554   
//  555   // Run the CRC calculation over the active body of code.
//  556   for (addr = HAL_SB_IMG_ADDR; addr < HAL_SB_IMG_ADDR + HAL_SB_IMG_SIZE; addr += chunk_size)
??calcCRC_2:
        MOV     ?V4,#0x0
        MOV     ?V5,#0x20
        MOV     ?V6,#0x0
        MOV     ?V7,#0x0
//  557   {
//  558 	if ((znpCfg1 == ZNP_CFG1_UART) || (znpCfg1 == ZNP_CFG1_UART_USB))
??calcCRC_3:
        MOV     DPTR,#znpCfg1
        MOVX    A,@DPTR
        JZ      ??calcCRC_4
        XRL     A,#0x2
        JNZ     ??calcCRC_5
//  559     {
//  560       sbUartPoll();
??calcCRC_4:
        ; Setup parameters for call to function sbUartPoll
        LCALL   sbUartPoll
//  561 
//  562       sbExec_rc = sbExec();
        ; Setup parameters for call to function sbExec
        LCALL   sbExec
        MOV     A,R1
        MOV     R0,A
//  563       if (sbExec_rc == SB_CMND_ENABLE_STATE_REPORTING)
        MOV     A,#0x9
        XRL     A,R0
        JZ      $+5
        LJMP    ??calcCRC_6
//  564       {
//  565         sbReportState(SB_STATE_VERIFYING);
        ; Setup parameters for call to function sbReportState
        MOV     R1,#0x0
        LCALL   sbReportState
//  566       }
//  567       else if ((sbExec_rc != SB_CMND_IDLE) &&
//  568                (sbExec_rc != SB_CMND_UNSUPPORTED) &&
//  569                (sbExec_rc != SB_CMND_FORCE_RUN))
//  570       {
//  571           *abort = TRUE;
//  572           break;
//  573       }
//  574     }
//  575     
//  576     if ((znpCfg1 == ZNP_CFG1_UART_USB) && (SB1_PRESS))
//  577     {
//  578       break;
//  579     }
//  580     
//  581     HalFlashRead(addr / HAL_FLASH_PAGE_SIZE, addr % HAL_FLASH_PAGE_SIZE, buf, chunk_size);
??calcCRC_5:
        ; Setup parameters for call to function HalFlashRead
        MOV     ?V0,#0x0
        MOV     ?V1,#0x2
        MOV     R0,#?V0
        LCALL   ?PUSH_XSTACK_I_TWO
          CFI CFA_XSP16 add(XSP16, 537)
        MOV     A,#0x2
        LCALL   ?XSTACK_DISP102_8
        MOV     ?V0,?V4
        MOV     ?V1,?V5
        MOV     R2,?V0
        MOV     A,?V1
        ANL     A,#0x7
        MOV     R3,A
        MOV     ?V2,?V6
        MOV     ?V3,?V7
        MOV     A,#0xb
        MOV     R0,#?V0
        LCALL   ?UL_SHR
        MOV     R1,?V0
        LCALL   HalFlashRead
        MOV     A,#0x2
        LCALL   ?DEALLOC_XSTACK8
          CFI CFA_XSP16 add(XSP16, 535)
//  582     for (i = 0; i < chunk_size; i++)
        MOV     R6,#0x0
        MOV     R7,#0x0
//  583     {
//  584       if ((addr + i < HAL_SB_CRC_ADDR) || (addr + i >= HAL_SB_CRC_ADDR + HAL_SB_CRC_LEN))
??calcCRC_7:
        MOV     DPTR,#__Constant_4
        PUSH    DPL
          CFI CFA_SP SP+-1
        MOV     ?V8,R6
        MOV     A,R7
        MOV     ?V9,A
        RLC     A
        SUBB    A,0xE0 /* A   */
        MOV     ?V10,A
        MOV     ?V11,A
        MOV     ?V0,?V4
        MOV     ?V1,?V5
        MOV     ?V2,?V6
        MOV     ?V3,?V7
        MOV     R0,#?V0
        MOV     R1,#?V8
        LCALL   ?L_ADD
        MOV     DPTR,#__Constant_ffffdf70
        MOV     R0,#?V0
        LCALL   ?L_ADD_X
        MOV     DPH,#(__Constant_4 >> 8) & 0xff
        POP     DPL
          CFI CFA_SP SP+0
        MOV     R0,#?V0
        LCALL   ?UL_GE_X
        JNC     ??calcCRC_8
//  585       {
//  586         crc = runPoly(crc, buf[i]);
        ; Setup parameters for call to function runPoly
        MOV     DPL,?XSP + 0
        MOV     DPH,?XSP + 1
        MOV     A,DPL
        ADD     A,R6
        MOV     DPL,A
        MOV     A,DPH
        ADDC    A,R7
        MOV     DPH,A
        MOVX    A,@DPTR
        MOV     R1,A
        MOV     R2,?V12
        MOV     R3,?V13
        LCALL   runPoly
        MOV     ?V12,R2
        MOV     ?V13,R3
//  587       }
//  588     }
??calcCRC_8:
        INC     R6
        MOV     A,R6
        JNZ     ??calcCRC_9
        INC     R7
??calcCRC_9:
        CLR     C
        MOV     A,R7
        SUBB    A,#0x2
        JC      ??calcCRC_7
        MOV     DPTR,#__Constant_200
        MOV     R0,#?V4
        LCALL   ?L_ADD_X
        MOV     DPTR,#__Constant_3c800
        MOV     R0,#?V4
        LCALL   ?UL_GE_X
        JC      $+5
        LJMP    ??calcCRC_3
//  589   }
//  590   
//  591   // IAR note explains that poly must be run with value zero for each byte of crc.
//  592   crc = runPoly(crc, 0);
??calcCRC_10:
        ; Setup parameters for call to function runPoly
        MOV     R1,#0x0
        MOV     R2,?V12
        MOV     R3,?V13
        LCALL   runPoly
//  593   crc = runPoly(crc, 0);
        ; Setup parameters for call to function runPoly
        MOV     R1,#0x0
        LCALL   runPoly
        MOV     ?V13,R3
//  594   
//  595   if (znpCfg1 == ZNP_CFG1_UART)
        MOV     DPTR,#znpCfg1
        MOVX    A,@DPTR
        JNZ     ??calcCRC_11
//  596   {
//  597     HAL_DISABLE_INTERRUPTS();
        CLR     0xa8.7
//  598     URX0IE = 0;
        CLR     0xa8.2
//  599   }
//  600 
//  601   if (crc == 0)
??calcCRC_11:
        MOV     A,R2
        ORL     A,?V13
        JNZ     ??calcCRC_12
//  602   {
//  603   	return 0xA5A5;
        MOV     R2,#-0x5b
        MOV     R3,#-0x5b
        SJMP    ??calcCRC_12
//  604   }
??calcCRC_6:
        MOV     A,R0
        JNZ     $+5
        LJMP    ??calcCRC_5
        MOV     A,#0x6
        XRL     A,R0
        JNZ     $+5
        LJMP    ??calcCRC_5
        MOV     A,#0x7
        XRL     A,R0
        JNZ     $+5
        LJMP    ??calcCRC_5
        MOV     DPL,?V14
        MOV     DPH,?V15
        MOV     A,#0x1
        MOVX    @DPTR,A
        SJMP    ??calcCRC_10
//  605   
//  606   return crc;
??calcCRC_12:
        MOV     DPL,#0x0
        MOV     DPH,#0x2
        LCALL   ?ADD_XSTACK_DISP0_16
          CFI CFA_XSP16 add(XSP16, 23)
        MOV     R7,#0x10
        LJMP    ?FUNC_LEAVE_XDATA
          CFI R6 SameValue
          CFI VB SameValue
          CFI V0 SameValue
          CFI V1 SameValue
          CFI V2 SameValue
          CFI V3 SameValue
          CFI V4 SameValue
          CFI V5 SameValue
          CFI V6 SameValue
          CFI V7 SameValue
          CFI V8 SameValue
          CFI V9 SameValue
          CFI V10 SameValue
          CFI V11 SameValue
          CFI V12 SameValue
          CFI V13 SameValue
          CFI V14 SameValue
          CFI V15 SameValue
          CFI R7 SameValue
          CFI ?RET_LOW Frame(CFA_SP, 1)
          CFI ?RET_HIGH Frame(CFA_SP, 2)
          CFI DPL0 SameValue
          CFI DPH0 SameValue
          CFI CFA_SP SP+-2
          CFI CFA_XSP16 XSP16+0
          CFI EndBlock cfiBlock23
        REQUIRE _A_IEN0
//  607 }
//  608 
//  609 /**************************************************************************************************
//  610  * @fn          runPoly
//  611  *
//  612  * @brief       Run the CRC16 Polynomial calculation over the byte parameter.
//  613  *
//  614  * input parameters
//  615  *
//  616  * @param       crc - Running CRC calculated so far.
//  617  * @param       val - Value on which to run the CRC16.
//  618  *
//  619  * output parameters
//  620  *
//  621  * None.
//  622  *
//  623  * @return      crc - Updated for the run.
//  624  **************************************************************************************************
//  625  */

        RSEG NEAR_CODE:CODE:NOROOT(0)
//  626 static uint16 runPoly(uint16 crc, uint8 val)
runPoly:
          CFI Block cfiBlock24 Using cfiCommon0
          CFI Function runPoly
        CODE
//  627 {
        ; Saved register size: 0
        ; Auto size: 0
//  628   const uint16 poly = 0x1021;
//  629   uint8 cnt;
//  630 
//  631   for (cnt = 0; cnt < 8; cnt++, val <<= 1)
        MOV     R0,#0x8
//  632   {
//  633     uint8 msb = (crc & 0x8000) ? 1 : 0;
??runPoly_0:
        MOV     A,R3
        ANL     A,#0x80
        JZ      ??runPoly_1
        SETB    B.0
        SJMP    ??runPoly_2
??runPoly_1:
        CLR     B.0
//  634 
//  635     crc <<= 1;
??runPoly_2:
        MOV     A,R2
        ADD     A,0xE0 /* A   */
        MOV     R2,A
        MOV     A,R3
        RLC     A
        MOV     R3,A
//  636     if (val & 0x80)  crc |= 0x0001;
        MOV     A,R1
        MOV     C,0xE0 /* A   */.7
        JNC     ??runPoly_3
        MOV     A,#0x1
        ORL     A,R2
        MOV     R2,A
//  637     if (msb)         crc ^= poly;
??runPoly_3:
        MOV     C,B.0
        JNC     ??runPoly_4
        MOV     A,#0x21
        XRL     A,R2
        MOV     R2,A
        MOV     A,#0x10
        XRL     A,R3
        MOV     R3,A
//  638   }
??runPoly_4:
        MOV     A,R1
        CLR     C
        RLC     A
        MOV     R1,A
        DEC     R0
        MOV     A,R0
        JNZ     ??runPoly_0
//  639 
//  640   return crc;
        RET
//  641 }
          CFI EndBlock cfiBlock24

        RSEG XDATA_I:XDATA:NOROOT(0)
        DATA32
__Constant_ffffffff:
        DS 4
        REQUIRE `?<Initializer for __Constant_ffffffff>`
        REQUIRE __INIT_XDATA_I

        RSEG XDATA_ID:CODE:NOROOT(0)
`?<Initializer for __Constant_ffffffff>`:
        DATA32
        DD 4294967295

        RSEG XDATA_I:XDATA:NOROOT(0)
        DATA32
__Constant_ffffdf70:
        DS 4
        REQUIRE `?<Initializer for __Constant_ffffdf70>`
        REQUIRE __INIT_XDATA_I

        RSEG XDATA_ID:CODE:NOROOT(0)
`?<Initializer for __Constant_ffffdf70>`:
        DATA32
        DD 4294958960

        RSEG XDATA_I:XDATA:NOROOT(0)
        DATA32
__Constant_4:
        DS 4
        REQUIRE `?<Initializer for __Constant_4>`
        REQUIRE __INIT_XDATA_I

        RSEG XDATA_ID:CODE:NOROOT(0)
`?<Initializer for __Constant_4>`:
        DATA32
        DD 4

        RSEG XDATA_I:XDATA:NOROOT(0)
        DATA32
__Constant_200:
        DS 4
        REQUIRE `?<Initializer for __Constant_200>`
        REQUIRE __INIT_XDATA_I

        RSEG XDATA_ID:CODE:NOROOT(0)
`?<Initializer for __Constant_200>`:
        DATA32
        DD 512

        RSEG XDATA_I:XDATA:NOROOT(0)
        DATA32
__Constant_3c800:
        DS 4
        REQUIRE `?<Initializer for __Constant_3c800>`
        REQUIRE __INIT_XDATA_I

        RSEG XDATA_ID:CODE:NOROOT(0)
`?<Initializer for __Constant_3c800>`:
        DATA32
        DD 247808

        END
//  642 
//  643 /**************************************************************************************************
//  644 */
// 
// 1 984 bytes in segment NEAR_CODE
//     2 bytes in segment SBL_CMD
//     4 bytes in segment SBL_REV
//     4 bytes in segment SBL_SIG
//     3 bytes in segment SFR_AN
//    20 bytes in segment XDATA_I
//    20 bytes in segment XDATA_ID
//     4 bytes in segment XDATA_N
//   135 bytes in segment XDATA_Z
// 
// 1 994 bytes of CODE  memory (+ 20 bytes shared)
//     0 bytes of DATA  memory (+  3 bytes shared)
//   139 bytes of XDATA memory (+ 20 bytes shared)
//
//Errors: none
//Warnings: none
